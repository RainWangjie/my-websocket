/*!
 * my-websocket v1.0.0 by Mr.Rain🌹
 * (c) 2019-2019 
 * http://git.tianrang-inc.com:city-simulator/canalization.git
 * Released under the MIT License.
 */
import{inflate as t}from"pako";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */var e,n=function(){return(n=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var s in e=arguments[n])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t}).apply(this,arguments)};function o(t,e,n,o){return new(n||(n=Promise))((function(s,r){function i(t){try{c(o.next(t))}catch(t){r(t)}}function a(t){try{c(o.throw(t))}catch(t){r(t)}}function c(t){t.done?s(t.value):new n((function(e){e(t.value)})).then(i,a)}c((o=o.apply(t,e||[])).next())}))}function s(t,e){var n,o,s,r,i={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return r={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(r){return function(a){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,o&&(s=2&r[0]?o.return:r[0]?o.throw||((s=o.return)&&s.call(o),0):o.next)&&!(s=s.call(o,r[1])).done)return s;switch(o=0,s&&(r=[2&r[0],s.value]),r[0]){case 0:case 1:s=r;break;case 4:return i.label++,{value:r[1],done:!1};case 5:i.label++,o=r[1],r=[0];continue;case 7:r=i.ops.pop(),i.trys.pop();continue;default:if(!(s=(s=i.trys).length>0&&s[s.length-1])&&(6===r[0]||2===r[0])){i=0;continue}if(3===r[0]&&(!s||r[1]>s[0]&&r[1]<s[3])){i.label=r[1];break}if(6===r[0]&&i.label<s[1]){i.label=s[1],s=r;break}if(s&&i.label<s[2]){i.label=s[2],i.ops.push(r);break}s[2]&&i.ops.pop(),i.trys.pop();continue}r=e.call(t,i)}catch(t){r=[6,t],o=0}finally{n=s=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,a])}}}!function(t){t[t["未连接"]=0]="未连接",t[t["连接中"]=1]="连接中",t[t["已连接"]=2]="已连接",t[t["断线"]=3]="断线",t[t["废弃"]=4]="废弃"}(e||(e={}));var r={protocol:"ws",url:"",host:document.location.host,port:80,isOpen:!0,reconnectNum:5},i=function(){function i(i){var a=this;this.status=e.未连接,this.reconnectNum=0,this.messageList={},this.registerList={},this.unSentList=[],this.open=function(){return o(a,void 0,void 0,(function(){return s(this,(function(t){switch(t.label){case 0:return[4,this.init()];case 1:return t.sent(),[2]}}))}))},this.removeMessage=function(t){"string"!=typeof t?t.forEach((function(t){return delete a.messageList[t]})):delete a.messageList[t]},this.removeMessageFunc=function(t,e){for(var n=a.messageList[t],o=n.length,s=0;s<o;s++)if(n[s]===e){n.splice(s,1);break}},this.init=function(){if(a.status!==e.连接中&&a.status!==e.废弃)return new Promise((function(t,n){a.status=e.连接中;var o=new WebSocket(a.opt.protocol+"://"+a.opt.host+":"+a.opt.port+a.opt.url);o.onopen=function(){a.onOpen(),t&&t()},o.onmessage=a.dealMessage,o.onclose=function(){clearTimeout(a.timer),console.log("WebSocketClosed!"),a.status=e.断线,a.reconnect()},o.onerror=function(){console.log("WebSocketError!"),console.log(a.name+"通讯失败!!!"),a.status=e.断线,a.reconnect(),n&&n()},a.ws=o}))},this.onOpen=function(){for(var t in console.log("websocket 已连接",a.name),a.status=e.已连接,a.registerList)a.registerList.hasOwnProperty(t)&&a.send(t,a.registerList[t]);for(var n=0,o=a.unSentList;n<o.length;n++){var s=o[n],r=(t=s.type,s.data);a.send(t,r)}a.unSentList=[]},this.dealMessage=function(t){return o(a,void 0,void 0,(function(){var e,n,o,r,i,a,c;return s(this,(function(s){switch(s.label){case 0:return t.data instanceof Blob?[4,this.dealUint8Array(t.data)]:[3,2];case 1:return e=s.sent(),[3,3];case 2:e=t.data,s.label=3;case 3:if(!e)return[2];try{n=JSON.parse(e),o=n.type,r=n.data,i=n.timestamp,a=this.messageList[o||"default"],c=new Date(i),a?a.forEach((function(t){return t(r,c)})):console.log(this.messageList,o,"无法处理此类消息")}catch(t){console.log(t)}return[2]}}))}))},this.dealUint8Array=function(e){return new Promise((function(n){var o=new FileReader;o.readAsArrayBuffer(e),o.onload=function(e){if(e.target.readyState===FileReader.DONE){var s=t(o.result),r=String.fromCharCode.apply(null,new Uint16Array(s));n(decodeURIComponent(r))}}}))},this.opt=n({},r,i),this.name=this.opt.url,this.reconnectNum=this.opt.reconnectNum,this.opt.isOpen&&this.open()}return i.prototype.send=function(t,o,s){if(void 0===s&&(s={}),this.status!==e.已连接)return this.open(),void this.unSentList.push({type:t,data:o});this.ws.send(JSON.stringify(n({type:t,data:o},s)))},i.prototype.message=function(t,e){void 0===t&&(t="default"),this.messageList.hasOwnProperty(t)||(this.messageList[t]=[]),this.messageList[t].push(e)},i.prototype.register=function(t,n,o){void 0===o&&(o={}),this.registerList[t]=n,this.status===e.已连接?this.send(t,n,o):this.open()},i.prototype.removeRegister=function(t){var e=this;"string"!=typeof t?t.forEach((function(t){return delete e.registerList[t]})):delete this.registerList[t]},i.prototype.close=function(){this.messageList={},this.registerList={},this.ws.close()},i.prototype.console=function(t,e,n){var o=this.messageList[t],s=new Date(e);o?o.forEach((function(t){return t(n,s)})):console.log("无法处理此类消息")},i.prototype.reconnect=function(){var t=this;if(this.status!==e.连接中){if(0===this.reconnectNum)return this.status=e.废弃,console.log(this.name+"已断线!!!请刷新"),void alert("与服务器失去链接，请刷新");this.reconnectNum--,console.log(this.name+"5s后开始第"+this.reconnectNum+"次重连"),this.timer=window.setTimeout((function(){t.open()}),5e3)}},i}();export default i;
//# sourceMappingURL=index.es.js.map
